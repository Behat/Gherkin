#!/usr/bin/env php
<?php

/*
 * This file is part of the Behat Gherkin Parser.
 * (c) Konstantin Kudryashov <ever.zet@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

$gherkinFile = __DIR__ . '/../vendor/cucumber/gherkin-monorepo/gherkin-languages.json';
$gherkinLanguages = Behat\Gherkin\Filesystem::readJsonFile($gherkinFile, true);
assert(is_array($gherkinLanguages));
$array = [];

foreach ($gherkinLanguages as $lang => $keywords) {
    $langMessages = [];

    assert(is_array($keywords));
    foreach ($keywords as $type => $words) {
        if (!is_array($words)) {
            $words = [$words];
        }

        if ($type === 'scenarioOutline') {
            $type = 'scenario_outline';
        }

        if (in_array($type, ['given', 'when', 'then', 'and', 'but'])) {
            $formattedKeywords = [];

            foreach ($words as $word) {
                assert(is_string($word));
                $formattedWord = trim($word);

                if ($formattedWord === $word) {
                    $formattedWord .= '<'; // Convert the keywords to the syntax used by Gherkin 2, which is expected by our Lexer.
                }

                $formattedKeywords[] = $formattedWord;
            }

            $words = $formattedKeywords;
        }

        usort($words, static function ($type1, $type2) {
            assert(is_string($type1));
            assert(is_string($type2));

            return [mb_strlen($type2, 'utf8'), $type1] <=> [mb_strlen($type1, 'utf8'), $type2];
        });

        $langMessages[$type] = implode('|', $words);
    }

    // ensure that the order of keys is consistent between updates
    ksort($langMessages);

    $array[$lang] = $langMessages;
}

// ensure that the languages are sorted to avoid useless diffs between updates. We keep the English first though as it is the reference.
$enData = $array['en'];
unset($array['en']);
ksort($array);
$array = array_merge(['en' => $enData], $array);
$arrayString = var_export($array, true);

file_put_contents(__DIR__ . '/../i18n.php', <<<EOD
<?php

/*
 * DO NOT TOUCH THIS FILE!
 *
 * This file is automatically generated by `bin/update_i18n`.
 * Actual Gherkin translations live in cucumber/gherkin repo:
 * https://github.com/cucumber/gherkin/blob/main/gherkin-languages.json
 * Please send your translation changes there.
 */

return $arrayString;
EOD
);
